---
title: "Redes"
author: "Marco Antonio Alvarado Serrano"
date: "3/6/2020"
output: powerpoint_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(EDAS)
library(DataExplorer)
library(readxl)
library(tidyverse)
require(gridExtra)
```

## Introducción

- Redes neuronales artificiales

- Shinny

- Coronavirus (COVID-19)

## Objetivos

- Crear una app multi-propósito para análisis de datos, que incluye un módulo para hacer clasificación mediante una red neuronal de arquitectura customizable mediante interfaz gráfica.

- Analizar la base de datos de COVID del gobierno para hacer clasificación sobre si una persona hospitalizada va a sobrevivir o no.

## Materiales

-R Studio

-Shinny app

## Resultados
- Cargamos los datos
```{r, message=F, warning=FALSE}
setwd("C:/Users/Marco/Downloads/GLM/Proyecto/")
datosCovid <- read_csv("200530COVID19MEXICO.csv")
catOrg <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 1)
catSec <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 2)
catSex <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 3)
catTipPac <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 4)
catSi_No <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 5)
catNac <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 6)
catRes <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 7)
catEnt <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 8)
catMun <- read_xlsx("diccionario_datos_covid19/Catalogos_0412.xlsx", sheet = 9)
datosCovid <- datosCovid[-c(1,2,3,7)]

#Convertimos las columnas de clase character a factor
datosCovid <-  EDAS::cambio_prop(datosCovid, 
                                 columns = which(sapply(datosCovid, class) != "Date"),
                                 prop = "factor")

datosCovid$EDAD <- as.factor(case_when(as.numeric(datosCovid$EDAD)  < 21 ~ 0, 
                                       as.numeric(datosCovid$EDAD)  %in%  21:30 ~ 1,
                                       as.numeric(datosCovid$EDAD)  %in%  31:40 ~ 2,
                                       as.numeric(datosCovid$EDAD)  %in%  41:50 ~ 3,
                                       as.numeric(datosCovid$EDAD)  %in%  51:60 ~ 4,
                                       as.numeric(datosCovid$EDAD)  > 60 ~ 5))
datosCovid <- datosCovid %>%
  mutate(aux =1, FECHA_DEF = as.factor(if_else(!is.na(FECHA_DEF),1,2))) %>%
  rename(DEFUNCION=FECHA_DEF)

datosCovidG <- datosCovid %>%
  select(INTUBADO, SEXO, EDAD, HIPERTENSION, DIABETES, OBESIDAD, EPOC, 
         ASMA, TABAQUISMO, INMUSUPR , NEUMONIA, DEFUNCION, RESULTADO) %>%
  filter(INTUBADO %in% c("1","2"), RESULTADO == "1", HIPERTENSION %in% c("1","2"),
         DIABETES %in% c("1","2"), OBESIDAD %in% c("1","2"), EPOC %in% c("1","2"),
         ASMA %in% c("1","2"), TABAQUISMO %in% c("1","2"), 
         INMUSUPR %in% c("1","2"), NEUMONIA %in% c("1","2"))  %>%
  select(-RESULTADO) %>%
  droplevels()
```
- Limpiamos la base
```{r, echo = TRUE}
names(datosCovidG)
```

- Modificamos la base a conveniencia
- Creamos la función auxiliar para las gráficas

```{r, warning=FALSE}
datosCovidGN <- datosCovidG  %>%
  mutate(aux = 1) %>%
  gather(key="key", value = "value", -c(DEFUNCION,aux)) %>%
  group_by(value,key) %>%
  group_by(key) %>%
  nest() 
```

## Vemos algunas gráficas

```{r}
graph2 <- function(data,b, labelsSF){
  data1 <- data[[2]][[b]] %>%
    group_by(DEFUNCION,value) %>%
    summarise(NAC = sum(aux)) %>%
    mutate(aux = sum(NAC), prop = NAC/aux)
  
  g1 <- data1 %>%
    ggplot(aes(x= DEFUNCION, y= NAC,fill=value)) + 
    geom_col(position="dodge") + 
    theme(axis.text.x = element_text(angle = 45, size = 20),
        axis.text.y = element_text(size = 20),
        axis.text=element_text(size=20, face="bold"),
        axis.title=element_text(size=25,face="bold"), 
        title = element_text(size = 20, face = "bold"),
        legend.text = element_text(size = 25),
        legend.title = element_text(size=30, face = "bold"))  + 
    xlab("DEFUNCION") +
    ylab(label = "Count") + 
    labs(title = paste("Numero de personas muertas dado", data[[1]][b])) + 
    scale_fill_discrete(name = data[[1]][b], labels = labelsSF) +
    geom_text(aes(y=NAC, label =  NAC), 
              size=7, alpha=1, position = position_dodge(1), vjust=-.5) + 
    scale_x_discrete(labels= c("Si", "No"))
  
  g2 <- data1 %>%
    ggplot(aes(x= DEFUNCION, y= prop,fill=value)) + 
    geom_col(position="dodge") + 
    theme(axis.text.x = element_text(angle = 45, size = 20),
        axis.text.y = element_text(size = 20),
        axis.text=element_text(size=20, face="bold"),
        axis.title=element_text(size=25,face="bold"), 
        title = element_text(size = 20, face = "bold"))  + 
    xlab("DEFUNCION") +
    ylab(label = "Prop") + 
    labs(title = paste("Porporcion de personas muertas dado", data[[1]][b])) + 
    guides(fill=F) +
    scale_y_continuous(position = "right") +
    geom_text(aes(y=prop, label =  paste0(round(prop,4)*100,"%")), 
              size=7, alpha=1, position = position_dodge(1), vjust=-.5) + 
    scale_x_discrete(labels= c("Si", "No"))
  
  grid.arrange(g1, g2, ncol=2)
}
```

- Vemos las gráficas
```{r, fig.width=20, fig.height=10, echo=T}
graph2(data = datosCovidGN, b = 1, labelsSF = catSi_No$DESCRIPCIÓN)
```

```{r, fig.width=20, fig.height=10, echo=TRUE}
graph2(data = datosCovidGN, b = 2, labelsSF = catSex$DESCRIPCIÓN)
```

```{r, fig.width=20, fig.height=10, echo=TRUE}
graph2(data = datosCovidGN, b = 3, 
       labelsSF = c("<21", "21-30", "31-40", "41-50", "51-60", "60<" ))
```

```{r, fig.width=20, fig.height=10, echo=TRUE}
graph2(data = datosCovidGN, b = 4, labelsSF = catSi_No$DESCRIPCIÓN)
```

```{r, fig.width=20, fig.height=10, echo=TRUE}
graph2(data = datosCovidGN, b = 5, labelsSF = catSi_No$DESCRIPCIÓN)
```

```{r, fig.width=20, fig.height=10, echo=TRUE}
graph2(data = datosCovidGN, b = 11, labelsSF = catSi_No$DESCRIPCIÓN)
```

